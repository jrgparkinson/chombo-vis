<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

  <title>Chombo Visualiser</title>


</head>

<body>

  <div id="container">
    <div id="loading" class="spinner-grow" style="width: 8rem; height: 8rem;" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <div id="aboutContainer"></div>
  <div id="fileSelectorContainer"></div>
  <div id="timeContainer">
    <div id="timeLabel">Time: </div>
    <div id="time"></div>
  </div>

</body>

<script type="text/javascript">

  var metadata;

  function populateFileList() {
    $.getJSON('/datafiles', function (data) {
      //data is the JSON string
      console.log('Data files: ' + data);

      var html = '';
      data.forEach(function (data_loc) {
        html = html.concat('<a href="/vis/' + data_loc + '" class="list-group-item list-group-item-action">' + data_loc + '</a>')
      })

      $("#fileList").html(html);

      // Check if current file is valid
      if (!data.includes(getDataFile())) {
        $("#fileSelector").modal({
            show: true,
            keyboard: false,
            backdrop: 'static'
        });
        console.log('Turn off loading');
        $("#loading").css("display", "none");
        $("#timeContainer").css("display", "none");

        // Disable closing file selector
        $("#closeFileSelector").css("display", "none");
        $(".close").css("display", "none");
        // $("#fileSelector").attrs("data-keyboard", false);

      }
    });
  }

  function getDataFile() {
    data_dir = '';
    var url_parts = window.location.pathname.split('/')
    if (url_parts && url_parts[1] == "vis") {
      data_dir = url_parts[2];
    }
    return data_dir
  }



  // Colour converters from  https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
  function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function (m, r, g, b) {
      return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
  }

  function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
  }

  // Sets RGB string from hex code selected
  function updateColourInput(inputId, hex) {
    if (inputId == undefined) { inputId = "#colourVal"; }
    if (hex == undefined) { hex = $("#colourValPicker").val(); }
    var { r, g, b } = hexToRgb(hex);
    let rgbStr = "rgb(" + r + "," + g + "," + b + ")";
    console.log('Update colour input set ' + inputId + ' = ' + rgbStr + " (from hex: " + hex +")");
    $(inputId).val(rgbStr);
  }

  

  // Set to Oxford Blue initially
  function setColourPicker() {
    var hex = $("#colourValPicker").val("#105db5");
    updateColourInput();
  }

  function updateColourPicker() {
    console.log('Update colour picker');
    var rgb = $("#colourVal").val();
    p = rgb.replace('rgb(', '').replace(')', '').split(',')

    var hex = rgbToHex(Number(p[0]),
      Number(p[1]), Number(p[2]));
    console.log('rgb: ' + p + ' => hex: ' + hex);
    $("#colourValPicker").val(hex);
  }

  function printFieldLimits(fieldInput, limitsId) {
    if (fieldInput == undefined) { fieldInput = "#field-addContour"; }
    if (limitsId == undefined) { limitsId = "#addContourLimits" }
    var field = $(fieldInput + " option:selected").text();

    var limits;
    metadata.pointData.arrays.forEach(function (array) {
      if (array.data.name == field) {
        limits = array.data.ranges[0];
      }
    });

    console.log(limits);
    console.log('Get limits for field: ' + field + ', limits: ' + limits);

    $(limitsId).html('Min: ' + Number(limits.min).toFixed(2)
      + '<br>Max: ' + Number(limits.max).toFixed(2));

  }

  $(document).ready(function () {
    populateFileList();
    document.title = getDataFile() + ' - Chombo Visualiser';

    setColourPicker();

    var metadata_url = '../../data/' + getDataFile() + '/fields.vti/index.json';
    console.log('Loading data from ' + metadata_url)
    $.getJSON(metadata_url, function (json) {

      metadata = json;
    });

    $(document).on("shown.bs.modal", "#addContour" , function() {
      printFieldLimits();
    });

    // Handle edit button
    $(document).on("click", "button.edit" , function() {
            console.log("Edit contour: " );
            console.log($(this)[0].dataset);

            let contourId = $(this)[0].dataset.id;
            let fieldId = $(this)[0].dataset.fieldid;
            let contourVal = $(this)[0].dataset.contourval;
            let color = $(this)[0].dataset.colour;

            let editModal = $("#editContour");
            
            // Setup edit modal for this contour
            editModal.find("#field-editContour").val(fieldId);
            editModal.find("#editContourDialogValue").val(contourVal); 

            $("#colourValPickerEdit").val(color);
            updateColourInput("#colourValEdit", color);

            // editModal.find("#editContourDialogBtn").dataset = {'id': contourId};
            
            editModal.find("#editContourDialogBtn").attr({"data-id": contourId});
            console.log('Edit button dataset:')
            console.log(editModal.find("#editContourDialogBtn").dataset);

            printFieldLimits("#field-editContour", "#editContourLimits");
        });

        $(document).on("change", "#colourValPicker" , function() {
          updateColourInput();
        });

        $(document).on('shown.bs.modal', "#fileSelector", populateFileList);

      
  });

  $("#fileSelector").on('shown.bs.modal', populateFileList);
  $("#colourVal").on('keyup', updateColourPicker);
  $("#field-addContour").on('change', printFieldLimits);
  $("#addContourBtn").on('click', printFieldLimits);
  $("#field-addContour").on('change', printFieldLimits);

  $("#field-editContour").on('change', function() {
    printFieldLimits("#field-editContour", "#editContourLimits");
  });
  //printFieldLimits(fieldInput, limitsId)

  $('#addContour').on('shown.bs.modal', function () {
    $('#field-addContour').focus();
  });

  $('#addContour').on('shown.bs.modal', function () {
    $('#field-addContour').focus();
  });

//   $("#contourListContainer li .contourControls").on("click", "button", function(event){
//     console.log($(this).text());
// });

   $('#editBtn').on('click', function(event) {
      console.log('Edit contour: ' + event.target.dataset.id);
    });

  $("body").on('keypress', function (event) {

    // Don't respond to key presses during a modal
    if ($('#addContour').is(':visible')
    || $('#editContour').is(':visible')
    || $('#fileSelector').is(':visible')) {
      return;
    }

    if (String.fromCharCode(event.charCode) == 'a') {
      $("#addContour").modal('show');
    } else if (String.fromCharCode(event.charCode) == 'c') {
      $("#collapseController").collapse('toggle');
    } else if (String.fromCharCode(event.charCode) == 'o') {
      $("#fileSelector").modal('show');
    }
  });

</script>

</html>